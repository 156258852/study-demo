<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XSS 攻击示例与防护</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        h1, h2 {
            color: #333;
        }
        
        .danger {
            color: #d32f2f;
            background-color: #ffebee;
            padding: 10px;
            border-radius: 4px;
        }
        
        .safe {
            color: #388e3c;
            background-color: #e8f5e9;
            padding: 10px;
            border-radius: 4px;
        }
        
        input, textarea, button {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        button {
            background-color: #2196F3;
            color: white;
            cursor: pointer;
        }
        
        button:hover {
            background-color: #0b7dda;
        }
        
        .comment {
            background-color: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #2196F3;
        }
        
        .vulnerable-box, .protected-box {
            min-height: 50px;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }
        
        .vulnerable-box {
            border: 2px solid #f44336;
            background-color: #ffebee;
        }
        
        .protected-box {
            border: 2px solid #4caf50;
            background-color: #e8f5e9;
        }
        
        code {
            background-color: #eee;
            padding: 2px 4px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>XSS 攻击示例与防护</h1>
    
    <div class="container">
        <h2>什么是 XSS 攻击？</h2>
        <p>
            XSS（Cross-Site Scripting，跨站脚本攻击）是一种代码注入攻击，攻击者通过在网页中注入恶意脚本，
            当其他用户浏览该网页时，恶意脚本会在用户浏览器中执行，从而窃取用户信息、劫持用户会话或进行其他恶意操作。
        </p>
        <p class="danger">
            <strong>危险：</strong>XSS 攻击可能导致用户会话劫持、身份伪造、敏感信息泄露等严重后果。
        </p>
    </div>
    
    <div class="container">
        <h2>XSS 攻击类型</h2>
        
        <h3>1. 反射型 XSS（Reflected XSS）</h3>
        <p>
            反射型 XSS 是最常见的 XSS 攻击类型。攻击者诱使用户点击一个恶意链接，该链接包含恶意脚本作为参数，
            服务器接收到参数后直接返回给浏览器执行。
        </p>
        
        <h3>2. 存储型 XSS（Stored XSS）</h3>
        <p>
            存储型 XSS 是最危险的 XSS 攻击类型。攻击者将恶意脚本提交到服务器并存储在数据库中，
            当其他用户访问包含恶意脚本的页面时，脚本会被执行。
        </p>
        
        <h3>3. DOM 型 XSS（DOM-based XSS）</h3>
        <p>
            DOM 型 XSS 是基于 DOM 文档对象模型的攻击。攻击脚本不经过服务器，
            而是通过修改页面的 DOM 节点来执行恶意代码。
        </p>
    </div>
    
    <div class="container">
        <h2>XSS 攻击示例</h2>
        
        <h3>1. 反射型 XSS 示例</h3>
        <p>恶意链接示例：</p>
        <code>http://example.com/search?q=&lt;script&gt;alert('XSS 攻击!')&lt;/script&gt;</code>
        <p>如果服务器直接将 q 参数输出到页面，就会执行恶意脚本。</p>
        
        <h3>2. 存储型 XSS 示例</h3>
        <p>在评论框中输入以下内容：</p>
        <div class="danger">
            &lt;script&gt;document.write("&lt;img src=x onerror=alert('存储型 XSS')&gt;");&lt;/script&gt;
        </div>
        <p>如果网站不进行过滤，这段脚本会被存储到数据库，每次页面加载时都会执行。</p>
        
        <h3>3. DOM 型 XSS 示例</h3>
        <p>以下是一个存在 DOM 型 XSS 漏洞的代码：</p>
        <div class="danger">
            <pre>&lt;script&gt;
  var keyword = location.hash.substring(1);
  document.write('&lt;h3&gt;搜索关键词: ' + keyword + '&lt;/h3&gt;');
&lt;/script&gt;</pre>
        </div>
        <p>攻击者可以构造 URL：<code>http://example.com/#&lt;script&gt;alert('DOM XSS')&lt;/script&gt;</code></p>
    </div>
    
    <div class="container">
        <h2>XSS 防护示例</h2>
        
        <h3>1. 存在漏洞的代码示例</h3>
        <div class="vulnerable-box">
            <h4>用户评论区（存在漏洞）</h4>
            <div id="vulnerable-comments">
                <!-- 用户评论将显示在这里 -->
            </div>
            
            <h4>添加评论</h4>
            <textarea id="vulnerable-input" placeholder="输入你的评论..."></textarea>
            <br>
            <button onclick="addVulnerableComment()">提交评论</button>
        </div>
        
        <h3>2. 已防护的代码示例</h3>
        <div class="protected-box">
            <h4>用户评论区（已防护）</h4>
            <div id="protected-comments">
                <!-- 用户评论将显示在这里 -->
            </div>
            
            <h4>添加评论</h4>
            <textarea id="protected-input" placeholder="输入你的评论..."></textarea>
            <br>
            <button onclick="addProtectedComment()">提交评论</button>
        </div>
    </div>
    
    <div class="container">
        <h2>XSS 防护方法</h2>
        
        <h3>1. 输入过滤</h3>
        <p>对用户输入进行严格的验证和过滤，移除或转义特殊字符。</p>
        
        <h3>2. 输出编码</h3>
        <p>根据输出位置对数据进行适当的编码：</p>
        <ul>
            <li>HTML 编码：&lt; → &amp;lt;，&gt; → &amp;gt;</li>
            <li>JavaScript 编码：将特殊字符转换为 Unicode</li>
            <li>URL 编码：空格 → %20</li>
        </ul>
        
        <h3>3. 内容安全策略（CSP）</h3>
        <p>通过设置 Content-Security-Policy 头部，限制页面可以加载的资源：</p>
        <code>Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline'</code>
        
        <h3>4. 使用安全的 API</h3>
        <p>避免使用 <code>innerHTML</code>、<code>document.write()</code> 等不安全的 API，改用 <code>textContent</code>、<code>createElement</code> 等。</p>
        
        <h3>5. 设置 HttpOnly Cookie</h3>
        <p>为敏感 Cookie 设置 HttpOnly 标志，防止 JavaScript 访问。</p>
    </div>
    
    <script>
        // 存在漏洞的评论功能
        function addVulnerableComment() {
            var input = document.getElementById('vulnerable-input');
            var comments = document.getElementById('vulnerable-comments');
            
            if (input.value.trim() !== '') {
                // 危险：直接使用 innerHTML，没有进行任何过滤
                comments.innerHTML += '<div class="comment">' + input.value + '</div>';
                input.value = '';
            }
        }
        
        // 已防护的评论功能
        function addProtectedComment() {
            var input = document.getElementById('protected-input');
            var comments = document.getElementById('protected-comments');
            
            if (input.value.trim() !== '') {
                // 安全：使用 textContent 或对输入进行转义
                var commentDiv = document.createElement('div');
                commentDiv.className = 'comment';
                commentDiv.textContent = input.value; // textContent 会自动转义HTML标签
                comments.appendChild(commentDiv);
                input.value = '';
            }
        }
        
        // XSS 防护函数：HTML 转义
        function escapeHtml(text) {
            var map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }
        
        // 模拟一些初始评论
        window.onload = function() {
            // 添加一些示例评论
            document.getElementById('vulnerable-comments').innerHTML = 
                '<div class="comment">这是一条正常的评论</div>' +
                '<div class="comment">另一条正常评论</div>';
                
            document.getElementById('protected-comments').innerHTML = 
                '<div class="comment">这是一条正常的评论</div>' +
                '<div class="comment">另一条正常评论</div>';
        };
    </script>
</body>
</html>