<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IndexedDB API 演示</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            margin-bottom: 30px;
        }
        h1, h2 {
            color: #333;
        }
        button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }
        button:hover {
            background-color: #45a049;
        }
        input, textarea {
            width: 100%;
            padding: 12px 20px;
            margin: 8px 0;
            box-sizing: border-box;
            border: 2px solid #ccc;
            border-radius: 4px;
        }
        .log {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            padding: 10px;
            height: 200px;
            overflow-y: scroll;
            margin-top: 10px;
            border-radius: 4px;
        }
        .record {
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
    </style>
</head>
<body>
    <h1>IndexedDB API 演示</h1>
    
    <div class="container">
        <h2>数据库操作</h2>
        <button id="createDB">创建/打开数据库</button>
        <button id="deleteDB">删除数据库</button>
    </div>

    <div class="container">
        <h2>添加数据</h2>
        <input type="text" id="userName" placeholder="用户名">
        <input type="email" id="userEmail" placeholder="邮箱">
        <button id="addUser">添加用户</button>
    </div>

    <div class="container">
        <h2>查询数据</h2>
        <button id="getAllUsers">获取所有用户</button>
        <input type="text" id="searchId" placeholder="根据ID查询用户">
        <button id="getUserById">根据ID查询</button>
    </div>

    <div class="container">
        <h2>更新数据</h2>
        <input type="text" id="updateId" placeholder="用户ID">
        <input type="text" id="updateName" placeholder="新用户名">
        <input type="email" id="updateEmail" placeholder="新邮箱">
        <button id="updateUser">更新用户</button>
    </div>

    <div class="container">
        <h2>删除数据</h2>
        <input type="text" id="deleteId" placeholder="要删除的用户ID">
        <button id="deleteUser">删除用户</button>
    </div>

    <div class="container">
        <h2>日志输出</h2>
        <div id="log" class="log"></div>
    </div>

    <script>
        // 数据库相关信息
        const DB_NAME = 'UserDatabase';
        const DB_VERSION = 1;
        const STORE_NAME = 'users';
        let db;

        // DOM 元素
        const logElement = document.getElementById('log');

        // 日志函数
        function log(message) {
            const time = new Date().toLocaleTimeString();
            const record = document.createElement('div');
            record.className = 'record';
            record.textContent = `[${time}] ${message}`;
            logElement.appendChild(record);
            logElement.scrollTop = logElement.scrollHeight;
        }

        // 错误处理函数
        function handleError(error) {
            log('错误: ' + error.message);
            console.error(error);
        }

        // 创建/打开数据库
        document.getElementById('createDB').addEventListener('click', () => {
            log('正在创建/打开数据库...');
            
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            
            request.onerror = function(event) {
                handleError(new Error('打开数据库失败: ' + request.error));
            };
            
            request.onsuccess = function(event) {
                db = event.target.result;
                log('成功打开数据库');
                
                // 显示数据库信息
                log(`数据库名称: ${db.name}`);
                log(`数据库版本: ${db.version}`);
            };
            
            // 当数据库首次创建或版本升级时触发
            request.onupgradeneeded = function(event) {
                db = event.target.result;
                log(`升级数据库从版本 ${event.oldVersion} 到 ${event.newVersion}`);
                
                // 创建对象仓库 (表)
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    const objectStore = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                    objectStore.createIndex('name', 'name', { unique: false });
                    objectStore.createIndex('email', 'email', { unique: true });
                    log('创建对象仓库: ' + STORE_NAME);
                }
            };
        });

        // 删除数据库
        document.getElementById('deleteDB').addEventListener('click', () => {
            log('正在删除数据库...');
            
            const deleteReq = indexedDB.deleteDatabase(DB_NAME);
            
            deleteReq.onsuccess = function() {
                log('数据库删除成功');
                db = null;
            };
            
            deleteReq.onerror = function(event) {
                handleError(new Error('删除数据库失败: ' + deleteReq.error));
            };
            
            deleteReq.onblocked = function() {
                log('删除数据库被阻塞，请关闭所有可能使用该数据库的标签页');
            };
        });

        // 添加用户
        document.getElementById('addUser').addEventListener('click', () => {
            if (!db) {
                log('请先打开数据库');
                return;
            }
            
            const name = document.getElementById('userName').value;
            const email = document.getElementById('userEmail').value;
            
            if (!name || !email) {
                log('请填写完整信息');
                return;
            }
            
            const user = { name, email };
            log('正在添加用户: ' + JSON.stringify(user));
            
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const objectStore = transaction.objectStore(STORE_NAME);
            const request = objectStore.add(user);
            
            request.onsuccess = function(event) {
                log('用户添加成功，ID: ' + event.target.result);
                // 清空输入框
                document.getElementById('userName').value = '';
                document.getElementById('userEmail').value = '';
            };
            
            request.onerror = function() {
                handleError(new Error('添加用户失败: ' + (request.error?.message || '未知错误')));
            };
        });

        // 获取所有用户
        document.getElementById('getAllUsers').addEventListener('click', () => {
            if (!db) {
                log('请先打开数据库');
                return;
            }
            
            log('正在获取所有用户...');
            
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const objectStore = transaction.objectStore(STORE_NAME);
            const request = objectStore.getAll();
            
            request.onsuccess = function(event) {
                const users = event.target.result;
                if (users.length === 0) {
                    log('暂无用户数据');
                } else {
                    log(`获取到 ${users.length} 个用户:`);
                    users.forEach(user => {
                        log(`ID: ${user.id}, 姓名: ${user.name}, 邮箱: ${user.email}`);
                    });
                }
            };
            
            request.onerror = function() {
                handleError(new Error('获取用户失败: ' + (request.error?.message || '未知错误')));
            };
        });

        // 根据ID获取用户
        document.getElementById('getUserById').addEventListener('click', () => {
            if (!db) {
                log('请先打开数据库');
                return;
            }
            
            const id = parseInt(document.getElementById('searchId').value);
            if (!id) {
                log('请输入有效的用户ID');
                return;
            }
            
            log('正在查询ID为 ' + id + ' 的用户...');
            
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const objectStore = transaction.objectStore(STORE_NAME);
            const request = objectStore.get(id);
            
            request.onsuccess = function(event) {
                const user = event.target.result;
                if (user) {
                    log(`找到用户: ID: ${user.id}, 姓名: ${user.name}, 邮箱: ${user.email}`);
                } else {
                    log('未找到ID为 ' + id + ' 的用户');
                }
            };
            
            request.onerror = function() {
                handleError(new Error('查询用户失败: ' + (request.error?.message || '未知错误')));
            };
        });

        // 更新用户
        document.getElementById('updateUser').addEventListener('click', () => {
            if (!db) {
                log('请先打开数据库');
                return;
            }
            
            const id = parseInt(document.getElementById('updateId').value);
            const name = document.getElementById('updateName').value;
            const email = document.getElementById('updateEmail').value;
            
            if (!id) {
                log('请输入有效的用户ID');
                return;
            }
            
            if (!name && !email) {
                log('请至少填写一个要更新的字段');
                return;
            }
            
            log('正在更新ID为 ' + id + ' 的用户...');
            
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const objectStore = transaction.objectStore(STORE_NAME);
            const getRequest = objectStore.get(id);
            
            getRequest.onsuccess = function(event) {
                const user = event.target.result;
                if (!user) {
                    log('未找到ID为 ' + id + ' 的用户');
                    return;
                }
                
                // 更新用户信息
                if (name) user.name = name;
                if (email) user.email = email;
                
                const updateRequest = objectStore.put(user);
                updateRequest.onsuccess = function(event) {
                    log('用户更新成功');
                    // 清空输入框
                    document.getElementById('updateId').value = '';
                    document.getElementById('updateName').value = '';
                    document.getElementById('updateEmail').value = '';
                };
                
                updateRequest.onerror = function() {
                    handleError(new Error('更新用户失败: ' + (updateRequest.error?.message || '未知错误')));
                };
            };
            
            getRequest.onerror = function() {
                handleError(new Error('查询用户失败: ' + (getRequest.error?.message || '未知错误')));
            };
        });

        // 删除用户
        document.getElementById('deleteUser').addEventListener('click', () => {
            if (!db) {
                log('请先打开数据库');
                return;
            }
            
            const id = parseInt(document.getElementById('deleteId').value);
            if (!id) {
                log('请输入有效的用户ID');
                return;
            }
            
            log('正在删除ID为 ' + id + ' 的用户...');
            
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const objectStore = transaction.objectStore(STORE_NAME);
            const request = objectStore.delete(id);
            
            request.onsuccess = function(event) {
                if (event.target.result === undefined && request.readyState === 'done') {
                    log('用户删除成功');
                    // 清空输入框
                    document.getElementById('deleteId').value = '';
                } else {
                    log('用户删除失败');
                }
            };
            
            request.onerror = function() {
                handleError(new Error('删除用户失败: ' + (request.error?.message || '未知错误')));
            };
        });

        // 页面加载完成后的初始化
        window.addEventListener('load', () => {
            log('IndexedDB 演示已加载');
            log('请先点击"创建/打开数据库"按钮开始');
        });
    </script>
</body>
</html>